---
- name: Create web folder
  file: path=/var/www/ojs.comertec.org/public_html state=directory mode=0755 owner=www-data group=www-data

- name: Create cache folder
  file: path=/var/www/ojs.comertec.org/public_html/cache state=directory mode=0700 owner=www-data group=www-data

- name: Create upload folder
  file: path=/var/www/ojs.comertec.org/public_html/files state=directory mode=0700 owner=www-data group=www-data

- name: Create logs folder
  file: path=/var/www/ojs.comertec.org/logs state=directory mode=0740 owner=www-data group=www-data

- name: Check permissions of nginx log folder
  file: path=/var/log/nginx state=directory mode=0744 owner=www-data group=www-data

- stat: path=/var/ojs.tar.gz
  register: ojs_installer

- name: Download OJS
  get_url:
    url: http://pkp.sfu.ca/ojs/download/ojs-3.0.0.tar.gz
    dest: /var/ojs.tar.gz
    mode: 0777
  when: ojs_installer.stat.exists == False

- stat: path=/var/www/ojs.comertec.org/public_html/favicon.ico
  register: ojs_folder_icon

- name: Unpack OJS
  shell: tar -xf /var/ojs.tar.gz -C /var/www/ojs.comertec.org/public_html --strip-components=1
  when: ojs_folder_icon.stat.exists == False
  notify:
    - restart nginx

- name: Fix OJS permissions
  file:
    path: /var/www/ojs.comertec.org
    mode: u=rwX,g=rX,o=rX
    owner: www-data
    group: www-data
    recurse: yes

- name: Change OJS Timezone
  replace: 
    dest: /var/www/ojs.comertec.org/public_html/config.inc.php 
    regexp: 'time_zone = "UTC"'
    replace: 'time_zone = "America/Sao_Paulo"'

- name: Make OJS work with Nginx
  replace: 
    dest: /var/www/ojs.comertec.org/public_html/config.inc.php 
    regexp: 'disable_path_info = Off'
    replace: 'disable_path_info = On'

- name: Change OJS DB driver to MySQLi
  replace: 
    dest: /var/www/ojs.comertec.org/public_html/config.inc.php 
    regexp: 'driver = mysql$'
    replace: 'driver = mysqli\n'